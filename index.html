<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WebRTC Demo</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    video { width: 300px; height: 200px; margin: 5px; background: black; }
    #videos { display: flex; flex-wrap: wrap; justify-content: center; }
  </style>
</head>
<body>
  <h2>WebRTC Demo - Multi User</h2>
  <div id="videos"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const peers = {};
    const videoGrid = document.getElementById("videos");

    // Add video stream to grid
    function addVideo(stream, id) {
      let video = document.getElementById(id);
      if (!video) {
        video = document.createElement("video");
        video.id = id;
        video.autoplay = true;
        video.playsinline = true;
        videoGrid.appendChild(video);
      }
      video.srcObject = stream;
    }

    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        addVideo(stream, "me");

        socket.on("user-joined", id => {
          const peer = new RTCPeerConnection();
          stream.getTracks().forEach(track => peer.addTrack(track, stream));

          peer.ontrack = event => addVideo(event.streams[0], id);
          peer.onicecandidate = e => e.candidate && socket.emit("ice-candidate", { to: id, candidate: e.candidate });

          peer.createOffer()
            .then(offer => {
              peer.setLocalDescription(offer);
              socket.emit("offer", { to: id, sdp: offer });
            });

          peers[id] = peer;
        });

        socket.on("offer", async data => {
          const peer = new RTCPeerConnection();
          stream.getTracks().forEach(track => peer.addTrack(track, stream));

          peer.ontrack = event => addVideo(event.streams[0], data.from);
          peer.onicecandidate = e => e.candidate && socket.emit("ice-candidate", { to: data.from, candidate: e.candidate });

          await peer.setRemoteDescription(new RTCSessionDescription(data.sdp));
          const answer = await peer.createAnswer();
          await peer.setLocalDescription(answer);

          socket.emit("answer", { to: data.from, sdp: answer });
          peers[data.from] = peer;
        });

        socket.on("answer", async data => {
          await peers[data.from].setRemoteDescription(new RTCSessionDescription(data.sdp));
        });

        socket.on("ice-candidate", async data => {
          try {
            await peers[data.from].addIceCandidate(new RTCIceCandidate(data.candidate));
          } catch (err) {
            console.error("ICE error:", err);
          }
        });

        socket.on("user-left", id => {
          if (peers[id]) {
            peers[id].close();
            delete peers[id];
          }
          const vid = document.getElementById(id);
          if (vid) vid.remove();
        });
      });
  </script>
</body>
</html>
