<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Rooms</title>
</head>
<body>
  <h1>WebRTC Rooms</h1>

  <button id="createBtn">Create Room</button>
  <input id="roomCode" placeholder="Enter room code">
  <button id="joinBtn">Join Room</button>

  <p id="status"></p>
  <video id="localVideo" autoplay playsinline muted></video>
  <video id="remoteVideo" autoplay playsinline></video>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const socket = io("https://webrtc-signal.onrender.com"); // replace with your server URL
    let pc, roomCode;

    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");

    // Create RTCPeerConnection
    function createPeerConnection(code) {
      pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });

      // Send ICE candidates to peer
      pc.onicecandidate = (event) => {
        if (event.candidate) {
          socket.emit("signal", { code, data: { candidate: event.candidate } });
        }
      };

      // Remote stream
      pc.ontrack = (event) => {
        remoteVideo.srcObject = event.streams[0];
      };

      // Local stream
      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then((stream) => {
          localVideo.srcObject = stream;
          stream.getTracks().forEach((track) => pc.addTrack(track, stream));
        });
    }

    // --- Socket events ---
    document.getElementById("createBtn").onclick = () => {
      socket.emit("create-room");
    };

    socket.on("room-created", (code) => {
      roomCode = code;
      document.getElementById("status").innerText = `Room created: ${code}`;
      createPeerConnection(code);
    });

    document.getElementById("joinBtn").onclick = () => {
      const code = document.getElementById("roomCode").value;
      if (code) socket.emit("join-room", code);
    };

    socket.on("room-joined", (code) => {
      roomCode = code;
      document.getElementById("status").innerText = `Joined room: ${code}`;
      createPeerConnection(code);

      // Start offer
      pc.createOffer().then((offer) => {
        pc.setLocalDescription(offer);
        socket.emit("signal", { code, data: { sdp: offer } });
      });
    });

    socket.on("user-joined", () => {
      // Host creates offer when second user joins
      pc.createOffer().then((offer) => {
        pc.setLocalDescription(offer);
        socket.emit("signal", { code: roomCode, data: { sdp: offer } });
      });
    });

    socket.on("signal", async ({ data }) => {
      if (data.sdp) {
        await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
        if (data.sdp.type === "offer") {
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          socket.emit("signal", { code: roomCode, data: { sdp: answer } });
        }
      } else if (data.candidate) {
        try {
          await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        } catch (e) {
          console.error("Error adding ice candidate", e);
        }
      }
    });

    socket.on("room-error", (msg) => {
      document.getElementById("status").innerText = `‚ùå ${msg}`;
    });
  </script>
</body>
</html>
