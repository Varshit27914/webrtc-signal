<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Rooms Demo</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 40px; }
    video { width: 45%; margin: 5px; border: 2px solid #333; }
  </style>
</head>
<body>
  <h2>WebRTC with Rooms</h2>

  <div id="controls">
    <button id="createRoom">Create Room</button>
    <input id="roomCodeInput" placeholder="Enter 4-digit code">
    <button id="joinRoom">Join Room</button>
    <p id="roomDisplay"></p>
  </div>

  <video id="localVideo" autoplay playsinline muted></video>
  <video id="remoteVideo" autoplay playsinline></video>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const socket = io("https://webrtc-signal.onrender.com"); 
let pc;

// Create PeerConnection
function createPeerConnection() {
  pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  // Send ICE candidates to peer
  pc.onicecandidate = (event) => {
    if (event.candidate) {
      socket.emit("candidate", { room: roomCode, candidate: event.candidate });
    }
  };

  // Show remote video
  pc.ontrack = (event) => {
    document.getElementById("remoteVideo").srcObject = event.streams[0];
  };

  // Add local stream
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
}

// Handle "ready" â†’ only first user makes offer
socket.on("ready", async () => {
  if (pc) {
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.emit("offer", { room: roomCode, offer });
  }
});

// Handle Offer
socket.on("offer", async (offer) => {
  if (pc) {
    await pc.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    socket.emit("answer", { room: roomCode, answer });
  }
});

// Handle Answer
socket.on("answer", async (answer) => {
  if (pc) {
    await pc.setRemoteDescription(new RTCSessionDescription(answer));
  }
});

// Handle ICE Candidates
socket.on("candidate", async (candidate) => {
  if (pc) {
    try {
      await pc.addIceCandidate(new RTCIceCandidate(candidate));
    } catch (e) {
      console.error("Error adding ICE candidate", e);
    }
  }
});

  </script>
</body>
</html>
