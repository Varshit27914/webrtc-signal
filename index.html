<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WebRTC Multi-User Demo</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f3f3f3; }
    #videos { display: flex; flex-direction: column; align-items: center; gap: 10px; }
    video { width: 400px; border: 2px solid #444; border-radius: 8px; }
  </style>
</head>
<body>
  <h2>ðŸ“¹ WebRTC Multi-User Demo</h2>
  <div id="videos">
    <video id="localVideo" autoplay muted playsinline></video>
  </div>

  <script>
    const socket = io();
    const localVideo = document.getElementById("localVideo");
    const videosDiv = document.getElementById("videos");

    let localStream;
    const peers = {}; // store all peers

    async function init() {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;
    }

    socket.on("user-joined", async (id) => {
      console.log("User joined:", id);
      const pc = createPeer(id, true);
      peers[id] = pc;
    });

    socket.on("offer", async (data) => {
      console.log("Received offer from", data.caller);
      const pc = createPeer(data.caller, false);
      peers[data.caller] = pc;
      await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.emit("answer", { sdp: answer, target: data.caller });
    });

    socket.on("answer", async (data) => {
      console.log("Received answer from", data.caller);
      const pc = peers[data.caller];
      await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
    });

    socket.on("ice-candidate", async (data) => {
      const pc = peers[data.from];
      if (pc) {
        try {
          await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        } catch (e) {
          console.error("Error adding ICE candidate", e);
        }
      }
    });

    socket.on("user-left", (id) => {
      console.log("User left:", id);
      if (peers[id]) {
        peers[id].close();
        delete peers[id];
        const vid = document.getElementById(id);
        if (vid) vid.remove();
      }
    });

    function createPeer(id, initiator) {
      const pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });

      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      pc.ontrack = (event) => {
        let video = document.getElementById(id);
        if (!video) {
          video = document.createElement("video");
          video.id = id;
          video.autoplay = true;
          video.playsinline = true;
          videosDiv.appendChild(video);
        }
        video.srcObject = event.streams[0];
      };

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          socket.emit("ice-candidate", { target: id, candidate: event.candidate });
        }
      };

      if (initiator) {
        pc.onnegotiationneeded = async () => {
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          socket.emit("offer", { sdp: offer, target: id });
        };
      }

      return pc;
    }

    init();
  </script>
</body>
</html>
